<view class="container">
  <view wx:if="{{!isLoggedIn}}" class="login-prompt">
    <view class="prompt-icon">ğŸ‘¤</view>
    <view class="prompt-text">è¯·å…ˆåœ¨é¦–é¡µç™»å½•</view>
    <view class="prompt-hint">ç™»å½•åæ‰èƒ½ä½¿ç”¨åˆ†æåŠŸèƒ½</view>
    <button class="btn-go-login" bindtap="goToIndex">å‰å¾€ç™»å½•</button>
  </view>

  <view wx:else>
    <view class="upload-section">
      <view class="upload-area" bindtap="showImagePicker">
        <image wx:if="{{imagePath}}" src="{{imagePath}}" class="preview-image" mode="aspectFit"></image>
        <view wx:else class="upload-placeholder">
          <text class="upload-icon">ğŸ“·</text>
          <text class="upload-text">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</text>
          <text class="upload-hint">æ”¯æŒç›¸å†Œå’Œæ‹ç…§</text>
        </view>
      </view>
    </view>

    <view class="input-section">
      <view class="input-label">ç”¨æˆ·å</view>
      <input 
        class="input-field" 
        placeholder="è¯·è¾“å…¥ç”¨æˆ·å" 
        value="{{username}}"
        bindinput="onUsernameInput"
      />
    </view>

    <view class="action-section">
      <button 
        class="btn-analyze" 
        bindtap="analyzeImage"
        disabled="{{!hasUploadedImage || analyzing}}"
      >
        {{analyzing ? 'åˆ†æä¸­...' : 'å¼€å§‹åˆ†æ'}}
      </button>
    </view>

    <view wx:if="{{!result && !analyzing}}" class="empty-state">
      <text class="empty-icon">ğŸ½ï¸</text>
      <text class="empty-text">ç­‰å¾…æŠ•å–‚å›¾ç‰‡</text>
      <text class="empty-hint">ä¸Šä¼ ä¸€å¼ ç¾é£Ÿå›¾ç‰‡å¼€å§‹åˆ†æ</text>
    </view>

    <view wx:if="{{parsedResult}}" class="analysis-card">
      <view class="dish-info">
        <text wx:if="{{parsedResult.dish_name}}" class="dish-name">{{parsedResult.dish_name}}</text>
        <text wx:if="{{parsedResult.description}}" class="dish-description">{{parsedResult.description}}</text>
      </view>

      <view wx:if="{{parsedResult.feature_tags && parsedResult.feature_tags.length > 0}}" class="tags-section">
        <view wx:for="{{parsedResult.feature_tags}}" wx:key="index" class="tag">
          {{item}}
        </view>
      </view>

      <view wx:if="{{pieChartData}}" class="pie-chart-section">
        <view class="pie-chart-wrapper">
          <view class="pie-chart">
            <canvas 
              type="2d" 
              id="pieCanvas" 
              class="pie-canvas"
              bindtap="onPieChartClick"
            ></canvas>
            <view class="pie-center">
              <text class="pie-center-text">{{pieChartData.total}}g</text>
              <text class="pie-center-subtext">æ€»é‡</text>
            </view>
          </view>
          <view class="pie-legend">
            <view wx:for="{{pieChartData.data}}" wx:key="name" class="legend-item" bindtap="onLegendItemClick" data-index="{{index}}">
              <view class="legend-color" style="background-color: {{item.color}};"></view>
              <text class="legend-emoji">{{getEmojiForCategory(item.name)}}</text>
              <text class="legend-text">{{item.name}}</text>
              <text class="legend-value">{{item.value}}g</text>
            </view>
          </view>
        </view>
      </view>

      <view class="nutrition-section">
        <view class="nutrition-header">
          <text class="nutrition-title">è¥å…»è¯¦æƒ…</text>
        </view>
        <view class="nutrition-content">
          <view wx:if="{{parsedResult.pagoda_nutrition_vector}}">
            <view class="nutrition-item">
              <text class="nutrition-label">è°·è–¯ç±»</text>
              <text class="nutrition-value">{{parsedResult.pagoda_nutrition_vector.L1 && parsedResult.pagoda_nutrition_vector.L1.total_value ? parsedResult.pagoda_nutrition_vector.L1.total_value : 0}}g</text>
            </view>
            <view class="nutrition-item">
              <text class="nutrition-label">è”¬æœç±»</text>
              <text class="nutrition-value">{{parsedResult.pagoda_nutrition_vector.L2 && parsedResult.pagoda_nutrition_vector.L2.total_value ? parsedResult.pagoda_nutrition_vector.L2.total_value : 0}}g</text>
            </view>
            <view class="nutrition-item">
              <text class="nutrition-label">è‚‰è›‹ç±»</text>
              <text class="nutrition-value">{{parsedResult.pagoda_nutrition_vector.L3 && parsedResult.pagoda_nutrition_vector.L3.total_value ? parsedResult.pagoda_nutrition_vector.L3.total_value : 0}}g</text>
            </view>
            <view class="nutrition-item">
              <text class="nutrition-label">å¥¶è±†åšæœ</text>
              <text class="nutrition-value">{{parsedResult.pagoda_nutrition_vector.L4 && parsedResult.pagoda_nutrition_vector.L4.total_value ? parsedResult.pagoda_nutrition_vector.L4.total_value : 0}}g</text>
            </view>
            <view class="nutrition-item oil-salt-item">
              <text class="nutrition-label">æ²¹</text>
              <text class="nutrition-value">{{parsedResult.pagoda_nutrition_vector.L5 && parsedResult.pagoda_nutrition_vector.L5.oil ? parsedResult.pagoda_nutrition_vector.L5.oil : 0}}g</text>
            </view>
            <view class="nutrition-item oil-salt-item">
              <text class="nutrition-label">ç›</text>
              <text class="nutrition-value">{{parsedResult.pagoda_nutrition_vector.L5 && parsedResult.pagoda_nutrition_vector.L5.salt ? parsedResult.pagoda_nutrition_vector.L5.salt : 0}}g</text>
              <view wx:if="{{parsedResult.pagoda_nutrition_vector.L5 && parsedResult.pagoda_nutrition_vector.L5.salt && parsedResult.pagoda_nutrition_vector.L5.salt > 5}}" class="salt-warning">
                <text class="warning-icon">âš ï¸</text>
                <text class="warning-text">ç›æ‘„å…¥é‡è¶…æ ‡</text>
              </view>
            </view>
          </view>
          <view wx:if="{{selectedCategoryDetails}}" class="category-details">
            <text class="category-details-title">{{selectedCategory}}è¯¦æƒ…</text>
            <text class="category-details-text">{{selectedCategoryDetails}}</text>
          </view>
        </view>
      </view>
    </view>

    <view wx:if="{{analyzing}}" class="loading-section">
      <view class="loading-spinner"></view>
      <text class="loading-text">æ­£åœ¨åˆ†æä¸­ï¼Œè¯·ç¨å€™...</text>
    </view>
  </view>
</view>
